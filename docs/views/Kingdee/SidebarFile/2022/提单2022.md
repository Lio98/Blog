---
title: '2022年提单复盘'
date: 2022-04-11
categories:
- "Kingdee"
tags:
- 工作笔记
isFull: false 
sidebar: true
isShowComments: true
isShowIndex: false
---

## 提单分析  

<span style="font-size:22px;">共计159个</span>

- 第16周(4.11-4.17) 16

    R20220408-3276，R20220408-1091，R20220406-1520，R20220407-3420，R20220407-4755，R20220409-0081，R20220407-1515，R20220409-1716，R20220408-3715，R20220409-2006，R20220411-2539，R20220408-0649，R20220412-4614，R20220415-1053，R20220412-0334

    1. **R20220411-2224**：修改操作执行超时时间限制

    ![](https://image.xjq.icu/2022/4/18/1650245938744_config.png)

- 第15周(4.4-4.10) 9

    R20220402-2462，R20220401-2646，R20220401-0149，R20220401-3134，R20220330-4478，R20220407-0748，R20220407-3060，R20220408-2637

    1. **R20220402-2801**：物料清单中更新没有任何报错， 但是物料清单批量维护更新的时候， 就处在保存物料清单完成界面，结果界面无任何信息，实际更新不成功

    **原因**：物料清单批量维护不显示bom保存失败的信息，实际更新不成功为bom修改后保存失败。
- 第14周(3.28-4.3) 19

    R20220324-1558，R20220326-1477，R20220327-0194，R20220328-0046，R20220323-0038，R20220325-1341，R20220326-1596，R20220325-2265，R20220329-0812，R20220326-0973，R20220331-1104，R20220331-0993，R20220331-4051，R20220331-2587，R20220325-0518，R20220329-4540

    1. **R20220328-2782**：生产订单是根据计划订单投放的，计划完工日期已经在计划订单维护好了 但是在生产订单上修改生产车间 计划完工日期会重新计算；客户不需要重算

    **解决方案**：在AfterBindData中在规则容器中移除实体服务规则，不会更新实体服务规则管理器中的对应实体服务规则，所以还是会执行；无法单独针对是否计划订单投放的生产订单移除对生产车间值更新触发计算日期的实体服务规则，移除的话手工新增的生产订单修改生产车间也会无法计算计划完工日期。可以接受生产订单新增的修改车间不计算计划完工日期，可二开添加如下代码：
    ![](https://image.xjq.icu/2022/4/11/1649641416509_entityRule.png)

    2. **R20220329-4446**：生产订单的单据类型为组织委托加工-汇报入库，对应的生产用料清单，新增行选择物料时会自动带出供料组织和供应方式，现在客户需要不要带出这两个字段值出来，默认为空，排查了BOS设计器的物料编码的值更新事件和子项明细的实体服务规则都没有找到相关设置。能不能二开生产用料清单手工新增行供应组织和供应方式不携带。

    **解决方案**：原本赋值在DataChange事件中填写，因为实体服务规则在DataChange事件之后，固配置实体服务规则清空对应的值
    ![](https://image.xjq.icu/2022/4/11/1649641420256_prdppbom.png)

    3. **R20220329-4287**：物料列表，使用检查按钮，是检查物料是否被业务单据使用，客户希望能有一个明细的界定，是哪些业务单据。后续可能有些业务单据是不需要参与校验的，想要了解插件的处理逻辑以便后续可以修改

    **系统单据和基础资料**：select * from T_META_OBJECTTYPE  WHERE FMODELTYPEID IN (400,100) AND FDEVTYPE IN (0,1)   FMODELTYPEID ：400-基础资料  100-单据  FDEVTYPE：非0，1为扩展的元数据

- 第13周(3.21-3.27) 11

    R20220317-0024，20220318-0745，R20220317-1299，R20220319-0668，R20220322-1137，R20220322-2129，R20220323-2709，R20220323-3228，R20220324-3136

    1. **R20220318-3392**：生产订单新增单据类型为研发订单，生产领料单新增单据类型为研发领料，现在制定研发生产单据类型下推指定生产领料单类型

    ![](https://image.xjq.icu/2022/3/28/1648431161666_Image_20220321171237.png)

    2. **R20220323-2582**：启用了辅助属性的物料就要控制生产订单的辅助属性必录，物料只有一个辅助属性的好控制，如果有多个辅助属性的，不好校验多个辅助属性都要录入，bos配置的保存校验不会生效，需要二开

    ![](https://image.xjq.icu/2022/3/28/1648431304095_Image_20220324174827.png)

- 第12周(3.14-3.20) 16

    R20220309-0788，R20220308-1793，R20220310-1489，R20220314-0067，R20220309-1491，R20220310-0598，R20220315-0491，R20220311-2131，R20220312-1539，R20220314-2220，R20220315-3676，R20220317-0962，R20220309-1964，R20220317-1847，R20220301-1966，R20220315-0943

    1. **R20220314-0067**：工序汇报下推生产入库单，需要设置【仓位】的固定值，不取物料里维护的仓位。

    **解决方案**：在单据转化插件中根据条件维护仓位的值
    
    ```python
    import clr 
    clr.AddReference('System')
    clr.AddReference('Kingdee.BOS')
    clr.AddReference('System.Data')
    clr.AddReference('Kingdee.BOS.Core')
    clr.AddReference('Kingdee.BOS.ServiceHelper')
    clr.AddReference('Kingdee.BOS.DataEntity')

    from System import *
    from System.Collections import *
    from System.Collections.Generic import List
    from Kingdee.BOS.Log import Logger
    from Kingdee.BOS.ServiceHelper import *
    from Kingdee.BOS.DataEntity import *
    from Kingdee.BOS.Orm.DataEntity import *

    def OnAfterConvertBusinessService(e):
    	entityDatas=e.TargetExtendedDataEntities.FindByEntityKey('FEntity')
    	if(entityDatas is not None):
    		for item in entityDatas:
    			stockId=long(item.DataEntity['StockId_Id'])
    			jhlb=str(item.DataEntity['F_PJWR_Assistant'])
    			Logger.Error("StockId_Id",str(stockId),None)
    			if(stockId==3144460):
    				if(jhlb!='5b07d8414de36f'):
    					item.DataEntity['StockLocId_Id']=100011
    				else:
    					item.DataEntity['StockLocId_Id']=100008
    				target=List[DynamicObject]()
    				target.Add(item.DataEntity)
    				DBServiceHelper.LoadReferenceObject(this.Context,target.ToArray() , item.DataEntity.DynamicObjectType, True)
    ```

    2. **R20220310-0598**： 生产用料清单变更单部分子项物料的BOM版本无法修改。

    **原因**：生产用料清单中有实体服务规则控制，存在下游单据则不允许变更子项bom版本等部分字段

    3. **R20220311-2131**：物料启用批号管理， 计划订单投放生产订单，在单据增加批号规则应用的表单服务策略，现投放的生产订单上可以显示批号，且设置单据类型参数生产订单自动审核、下达、开工，现下推的生产汇报单上无法带出生产订单上的批号。经检查是数据库批号的内码为空，如果生产订单手工保存一次，再下推生产汇报单是可以带出批号。

    **原因**：批号拣货服务是在保存时触发，计划订单投放不会触发此服务，在审核时重新调用生产订单保存即可。

    ```python
    import clr
    clr.AddReference('System')
    clr.AddReference('System.Data')
    clr.AddReference('Kingdee.BOS')
    clr.AddReference('Kingdee.BOS.Core')
    clr.AddReference('Kingdee.BOS.App')
    clr.AddReference('Kingdee.BOS.DataEntity')
    clr.AddReference('Kingdee.BOS.Contracts')
    clr.AddReference('Kingdee.BOS.ServiceHelper')

    from Kingdee.BOS import *
    from Kingdee.BOS.Core import *
    from Kingdee.BOS.Contracts import *
    from Kingdee.BOS.Orm.DataEntity import *
    from Kingdee.BOS.DataEntity import *
    from Kingdee.BOS.Core.Bill import *
    from Kingdee.BOS.Core.DynamicForm.PlugIn import *
    from Kingdee.BOS.Core.DynamicForm.PlugIn.ControlModel import *
    from System import *
    from System.Data import *
    from Kingdee.BOS.App.Data import *
    from System.Collections.Generic import List
    from Kingdee.BOS.ServiceHelper import *
    from Kingdee.BOS.Log import *


    def BeforeExecuteOperationTransaction(e):
    	idList=List[object]();
    	for billObj in e.SelectedRows:
    		BillId=billObj.DataEntity["Id"];
    		idList.Add(BillId)
    	if(idList.Count <= 0):
    		return;
    	meta=MetaDataServiceHelper.Load(this.Context,"PRD_MO");
    	billDatas=BusinessDataServiceHelper.Load(this.Context,idList.ToArray(),meta.BusinessInfo.GetDynamicObjectType());
    	saveRslt=BusinessDataServiceHelper.Save(this.Context,meta.BusinessInfo,billDatas,None,"Save");
    ```

    4. **R20220312-1539**：生产订单下两行产品，反写规则设置为允许超额一次，第一行物料下推生产入库时超订单入库，可以正常保存审核，第二行入库时增加联产品，入库单保存时提示第一行物料超出数量限制。

    **原因**：生产入库单增加联副产品，保存时会给对应的生产订单增加联副产品，重新调用生产订单保存，保存时有校验"入库上限须大于等于合格品入库选单数量+不合格品入库选单数量..."


- 第11周(3.7-3.13) 13

    R20220303-0721，R20220305-0190，R20220302-2115，R20220301-2611，R20220303-0309，R20220305-0771，R20220308-1204，R20220309-3385，R20220309-2264

    1. **R20220302-1981**：生产用料清单变更单，保存报错： 关联的用料清单已打开，需先关闭用料清单

    **原因**：这个提示为标准产品的校验器，如果用料清单中包含替代件，则可触发此校验

    2. **R20220306-0510**：客户实际问题是领料时发现有个别物料在用料清单上是没有的，现在是直接webapi在领料单上增加一行，这样是只关联了工单，没有关联用料清单的，咨询怎么可以同时对用料清单进行一个反写新增一行数据。

    **解决方案**：采用生产补料单的方式来做，会在用料清单中新增补料单对应的分录

    3. **R20220308-0390**：批改生产订单表头【单据日期】的效果，是否可以控制【计划】状态下的生产订单，不能通过批改的方式修改表头【日期】

    [单据配置批改操作](https://vip.kingdee.com/questions/149114/answers/176971)

    **解决方案**：配置python保存校验器来处理

    ```python
    import clr 
    clr.AddReference('System')
    clr.AddReference('Kingdee.BOS')
    clr.AddReference('Kingdee.BOS.Core')

    from System import *
    from System.Collections import *
    from System.Collections.Generic import *
    from Kingdee.BOS.Core import *
    from Kingdee.BOS.Core.Metadata import *
    from Kingdee.BOS.Core.Metadata.EntityElement import *
    from Kingdee.BOS.Core.DynamicForm.PlugIn import *
    from Kingdee.BOS.Core.Validation import *
    from Kingdee.BOS.Log import Logger

    def OnPreparePropertys(e):
    	e.FieldKeys.Add('FStatus')

    def OnAddValidators(e):
    	batchEditFields=this.Option.GetVariableValue[Dictionary[str, object]]("BatchEditFields",None)
    	if(this.Option.GetVariableValue("IsBatchEdit",False) and batchEditFields is not None and "FDate" in batchEditFields):
    		validateBillDate=ValidateBillDate() 
    		validateBillDate.EntityKey="FBillHead"
    		validateBillDate.AlwaysValidate=True
    		e.Validators.Add(validateBillDate)
    
    class ValidateBillDate(AbstractValidator):
    	def Validate(self,dataEntities,validateContext,ctx):
    		for bill in dataEntities:
    			treeEntity=bill.DataEntity['TreeEntity']
    			for item in treeEntity:
    				status=str(item['Status'])
    				if(status != '1'):
    					billId=str(bill['Id'])
    					currentSeq=str(item['seq'])
    					msg='子项明细第'+currentSeq+'行业务状态不为计划，不可批改单据日期'
    					errorInfo=ValidationErrorInfo(" ",billId,bill.DataEntityIndex,bill.RowIndex,billId,msg,"",ErrorLevel.FatalError)
    					validateContext.AddError(None,errorInfo)
    					break
    ```

    4. **R20220308-3890**：生产订单提交的时候报错,“Microsoft.Scripting.Interpreter.InterpretedFrameInfo”不是“System.String”类型，不能在此泛型集合中使用。参数名: key

    **原因**：在提交中配置了python插件执行存储过程插入数据，在执行存储过程中报错

- 第10周(2.28-3.6) 10

    R20220222-3725，R20220228-1557，R20220224-2899，R20220225-1845，R20220301-0373，R20220225-0201，R20220228-4867，R20220228-1608，R20220303-1444

    1. **R20220301-4148**：生产汇报单 的单据日期显示长时间
    ![](https://image.xjq.icu/2022/3/7/1646616547110_billdatetime2.png)
    ![](https://image.xjq.icu/2022/3/7/1646616547111_billdatetime.png)


- 第9周(2.21-2.27) 8

    R20220217-0，R20220219-0762，R20220218-2621，R20220217-0144，R20220218-3786，R20220218-3423，R20220221-0581

    1. **R20220222-0957**：生产用料清单重新审核状态，作业字段变成不可修改，bos中未见相关控制可以取消该字段锁定，取消表单插件也无效。

    **原因**：用料清单上有个实体服务规则，如果领料选单数量大于0则在重新审核状态下作业，工序作业都是锁定不可编辑的。

- 第8周(2.14-2.20) 10

    R20220211-0899，R20220211-3649，R20220210-4194，R20220211-0804，R20220212-1150 ，R20220211-3249，R20220215-3013，R20220215-1707，R20220214-3518

    1. **R20220211-3710**：客户调用的是 生产领料保存的API。 生产领料单的日期设置为长日期，没有操作 生产订单，现在的情况是  领料单保存后  生产订单状态会自动变成 开工，开工日期也是自动有了，但是没有 时分秒。 如果不通过api 手工下推生产领料单的生产订单自动开工，是会有日期和时分秒的。

    **原因**：WebAPI支持长日期类型，客户将日期类型的字段显示为"YY/MM/dd HH:mm:ss"格式，WebAPI传入时json内没有传入FDate的值，固其值按缺省值公式取了当前的日期，时间为00:00:00，在json中传入对应的格式的日期值可按传入的值显示
    
- 第5周(1.24-1.29) 12

    R20220124-3239，R20220114-0472，R20220125-0809，R20220122-1174，R20220122-1326，R20220126-2593，R20220126-2751，R20220126-1866，R20220128-1411

    1. **R20220120-0826**：客户是多组织模式，物料创建的时候，想实现A组织创建物料发料方式默认用调拨倒冲，B组织创建物料默认用直接倒冲，如何设置。

    ![](https://image.xjq.icu/2022/2/18/1645172699193_materialconfig.png)

    2. **R20220122-1104**：客户反馈由于物料过多需要设置物料名称+规格型号拼接的形式在物料列表中进行模糊查询，例如物料名称ABC，规格型号123，客户想直接输入AB12然后查询出名称包含AB，规格型号包含12的物料，

    ```python
    # 新增一个物料按名称+规格型号拼接，保存后刷新此字段，列表按照新增的字段查询
    def BeginOperationTransaction(e):
	materialDatas=e.DataEntitys
	for item in materialDatas:
		name=item['Name']
		currentName=name[this.Context.UserLocale.LCID]
		specification=item['Specification']
		currentSpecification=specification[this.Context.UserLocale.LCID]
		item['Texts']=currentName+'_'+currentSpecification

    # 更新历史数据
    update a set a.FTEXT=b.fname+'_'+b.FSPECIFICATION  from t_bd_material a 
    inner join t_bd_material_l b on a.fmaterialid=b.fmaterialid
    where b.flocaleid=2052
    ```

    3. **R20220124-0770**：生产用料清单下推生产领料单后，在库存查询-选择多个批号的库存进行返回数据后，申请数量也会一起返回。客户想要实现类似销售出库单的返回数据，应发数量不会重复。

    ![](https://image.xjq.icu/2022/2/18/1645172699192_pickmtrl.png)
    ![](https://image.xjq.icu/2022/2/18/1645172699192_saleoutstock.png)

    **原因**：库存查询供应链那边代码里使用了行复制，想要不复制申请数量，在bos中把申请数量功能控制中允许复制去掉勾选即可

- 第4周(1.17-1.23) 15

    R20220114-1724，R20220114-4230，R20220114-0588，R20220117-347，R20220118-3926，R20220117-0736，R20220118-0999， R20220117-4226，R20220121-0886，R20220120-1032，R20220110-2248 

    1. **R20211223-2674**：物料清单批量维护，变更子项，模拟列表显示正常，最后一步处理结果提示成功，进度走到100%，更是没有但没有具体明细且检查BOM并没有修改成功。

    **原因**：实际物料清单保存失败，未显示保存错误信息，导致进度条到100%，但未有具体执行执行明细

    2. **R20220117-3732**：通过配置的方式获取即时库存

    ![](https://image.xjq.icu/2022/1/24/1642988529978_kucun.png)

    3. **R20220113-2175**：生产订单下推工序汇报单，生产入库单反写生产订单数量出错(下推工序汇报后的反写是北研那边处理的，生产入库单和生产订单之间的单据关联关系已断掉)

    4. **R20220120-3365**：审批流中配置上查操作

    ![](https://image.xjq.icu/2022/1/24/1642989031212_flow.png)


- 第3周(1.10-1.16) 11

    R20220106-5216，R20220104-3676，R20220108-0529，R20220111-0847，R20220107-4109，R20220106-4336，R20220110-4653，R20220108-0736

    1. **R20220105-3134**：物料清单分配提升成功，但是子项没分配过去

    **原因**：树形维护业务操作中的分配，只是单个物料清单的分配，不是整个BOM树的分配，如果想整个BOM树的分配，需要用批量分配

    **解决方案**：在bom树形维护使用批量分配，即可把子项物料对应的bom进行分配

    2. **R20220110-1140**：WebApi接口，可以允许传入忽略交互的参数标志，具体参数 InterationFlags：交互标志集合，字符串类型，分号分隔，格式"flag1;flag2;..."（非必录）

    **解决方案**："IgnoreInterationFlag"这个属性传个true交互式相当于默认就点了是

    3. **R20220110-3335**：webapi方式新增物料传入图片

    ![](https://image.xjq.icu/2022/1/17/1642386698577_materialImage.png)

- 第2周(1.04-1.09) 9

    R20220102-0193，R20211230-0079，R20211230-3201,R20211229-4568 ,R20211230-0453，R20220103-1020，R20220106-4627，R20220107-0252

    1. **R20220103-0030**：想要实现有报表可以按照bom多级展开查看物料的可用量，即即时库存-预计出+预计入的数量，调用预计可发量接口

    **解决方案**：新建类继承TreeBomQueryForward，重写RefreshEntityView()方法，在此方法中遍历物料清单正查结果数据包bomQueryChildItems，根据此数据包中物料的信息调用获取预计可发量接口得到可用量信息填充至物料清单正查数据包对应属性，刷新界面；在物料清单正查上取消原本插件，注册上二开插件即可。

    [获取预计可发量接口参考帖子](https://vip.kingdee.com/article/3763)
    [物料清单正查二开参考帖子](https://vip.kingdee.com/article/137580948630829824)

