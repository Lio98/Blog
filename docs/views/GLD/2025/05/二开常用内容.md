---
title: '二开常用内容'
date: 2025-05-28
categories:
- "GLD"
tags:
- 工作笔记
sidebar: true
isFull: false
isShowComments: true
isShowIndex: true
isShowDetailImg: true
---

## 注入js脚本

```sql
----
DECLARE @F_ID NUMBER(19, 0),@F_COUNT NUMBER(19, 0);
SELECT @F_ID=ISNULL(MAX(F_ID),400000)+1 FROM TE_INJECT_JS where F_ID>400001 and F_ID<500000;

select @F_COUNT =  count(F_ID) from TE_INJECT_JS where F_MODULE_CODE = 'GEPS.Contract.Expenditure.QTZCHTModule' and F_PATH = '..\..\..\..\Common\DTJS\QTZCHT_INJECT.js';
if @F_COUNT = 0 THEN
set  @F_ID = @F_ID+1;
insert into TE_INJECT_JS (F_ID,F_MODULE_CODE,F_PATH,F_EVENTPOINT) values(@F_ID,'GEPS.Contract.Expenditure.QTZCHTModule','..\..\..\..\Common\DTJS\QTZCHT_INJECT.js','afterInit');
END;

```

## js添加按钮

```js
var toolbar = $G.getCmp("gvFYMX").toolbars[0];
var btn = _addButton('选择材料字典', 'XZCLZD', '/Common/images/toolbar/GEPS_Select.png', function () {
    SelectCLZD();
}, this, false);

toolbar.insertButton(4, btn);

function _addButton(text, code, iconPath, eventHandler, sender, disabled) {
    var button = new Ext.Button({
        id: 'ext_btn_' + code,
        icon: iconPath,
        text: text,
        disabled: disabled || false,
        tooltip: text,
        listeners: {
            click: eventHandler
        }
    });
    return button;
};
$G.States.on("statechange", function (s) {
    var btnXZCLZD = $G.getCmp("ext_btn_XZCLZD");
    var btnSelectFyxm = $G.getCmp("btnSelectFyxm");
    if (btnXZCLZD) {
        if (btnSelectFyxm)
            btnXZCLZD.setDisabled(btnSelectFyxm.disabled);
        else
            btnXZCLZD.setDisabled(s.bizState != "EDIT")
    }
});
```

## 添加权限项脚本

```sql
DECLARE 
@Row_Count NUMBER(19,0), 
@RESOURCE_MAX_ID NUMBER(19,0),
@ModuleTreeFullCode nvarchar(255),

@ModuleFullName nvarchar(255),
@ActionDisplayName nvarchar(255),
@ActionCode nvarchar(255),
@AuthFullCode nvarchar(255),
@ModuleCode nvarchar(255),
@EntityFullName nvarchar(255),
@EntityDispalyName nvarchar(255),

@RES_MOD_REL_MAX_ID NUMBER(19,0),
@LABEL_ID NUMBER(19,0), 
@FUNCTION_MAX_ID NUMBER(19,0),
@DIM_MAX_ID NUMBER(19,0),
--权限项组、资源、功能的新增数量
@GROUP_INSERT_NUM NUMBER(10), 
@RESOURCE_INSERT_NUM NUMBER(10), 
@FUNCTION_INSERT_NUM NUMBER(10),
@RES_MOD_REL_INSERT_NUM NUMBER(10),
@DIM_INSERT_NUM NUMBER(10),
--权限项组、资源、功能的当前Sequence的值
@GROUP_CURRENT_VALUE NUMBER(19,0),
@RESOURCE_CURRENT_VALUE NUMBER(19,0),
@FUNCTION_CURRENT_VALUE NUMBER(19,0),
@RES_MOD_REL_CURRENT_VAL NUMBER(19,0),
@DIM_CURRENT_VALUE NUMBER(19,0),
--更新的主键值
@UPDATE_INDEXS VARCHAR(1024),
@HASUPDATE NUMBER(10);
SET @GROUP_INSERT_NUM = 0;
SET @RESOURCE_INSERT_NUM = 0;
SET @FUNCTION_INSERT_NUM = 0;
SET @RES_MOD_REL_INSERT_NUM=0;
SET @DIM_INSERT_NUM=0;
SET @HASUPDATE=0;

--实体右键拷贝全名称
SET @ModuleFullName = N'GEPS.Labor.Contract.LWFBYJS';
--module右键拷贝全名称 
SET @ModuleCode = N'GEPS.Labor.Contract.LWFBYJSModule';
--权限编码，自定义取名，取按钮编码
SET @ActionCode = N'QHCWDJ';
----权限编码，自定义取名，取按钮名称
SET @ActionDisplayName =  N'取回财务单据';
--权限全编码
SET @AuthFullCode = @ModuleCode+N'.'+@ActionCode;
--实体别名
SET @EntityDispalyName = N'劳务分包预结算';

--------------------生成数据项脚本------------------------------
--/****** Object:  Table [dbo].[T_AUTH_RESOURCE]Script Date:2021/8/27 13:56:11 ******/--
SELECT @Row_Count = COUNT(*) FROM T_AUTH_RESOURCE WHERE F_FULLCODE = @ModuleFullName;
IF (@Row_Count>0) THEN
SELECT @RESOURCE_MAX_ID = F_RESOURCE_ID FROM T_AUTH_RESOURCE WHERE F_FULLCODE = @ModuleFullName;
UPDATE T_AUTH_RESOURCE 
SET F_NAME = @EntityDispalyName,
F_DESCRIPT=N'{"TypeName":"' + @ModuleFullName+N'"}',
F_ADAPTER_TYPE=N'EntityAdapter',
F_ADAPTER_NAME=N'实体适配器',
F_INSTANCE_SELECTABLE=1,
F_COLUMNS_SELECTABLE=0,
F_CONDITION_SELECTABLE=1,
F_IMAGE_PROPERTY=N'',
F_IMAGE_TYPE=N'',
F_IMAGE_TARGET=N'' WHERE F_RESOURCE_ID = @RESOURCE_MAX_ID;
ELSE
SELECT @RESOURCE_MAX_ID=ISNULL(MAX(F_RESOURCE_ID), 0) FROM T_AUTH_RESOURCE;
SET @RESOURCE_MAX_ID = @RESOURCE_MAX_ID+1;
INSERT INTO T_AUTH_RESOURCE(F_RESOURCE_ID, F_NAME, F_ADAPTER_TYPE, F_ADAPTER_NAME, F_DESCRIPT, F_IS_BUILDIN, F_FULLCODE,F_INSTANCE_SELECTABLE,F_COLUMNS_SELECTABLE,F_CONDITION_SELECTABLE,F_IMAGE_PROPERTY,F_IMAGE_TYPE,F_IMAGE_TARGET) 
VALUES (@RESOURCE_MAX_ID, @EntityDispalyName, N'EntityAdapter', N'实体适配器' ,N'{"TypeName":"' + @ModuleFullName+N'"}', 1, @ModuleFullName,1,0,1,N'',N'',N''); 
--生成相关的模块
SELECT @Row_Count = COUNT(*) FROM T_AUTH_RES_MODULE_REL WHERE F_MODULE_CODE=@ModuleCode AND F_DATARESOURCE_ID = @RESOURCE_MAX_ID;
IF (@Row_Count<1) THEN
SELECT @RES_MOD_REL_MAX_ID = ISNULL(MAX(F_ID),0) FROM T_AUTH_RES_MODULE_REL;
SET @RES_MOD_REL_MAX_ID = @RES_MOD_REL_MAX_ID+1;
INSERT INTO T_AUTH_RES_MODULE_REL(F_ID,F_MODULE_CODE,F_DATARESOURCE_ID) VALUES(@RES_MOD_REL_MAX_ID,@ModuleCode,@RESOURCE_MAX_ID);
SET @RES_MOD_REL_INSERT_NUM = @RES_MOD_REL_INSERT_NUM+1;

END;
SET @RESOURCE_INSERT_NUM = @RESOURCE_INSERT_NUM+1;
END;
   SELECT @Row_Count = COUNT(*) FROM T_AUTH_RES_DIM_RELATIONS WHERE F_PRIMARY_PROPERTY='Dept' AND F_DATA_RESOURCE_ID = @RESOURCE_MAX_ID AND F_NAME='GTP.Org.Dim.OwnerDepartment';
IF (@Row_Count<1) THEN
SELECT @DIM_MAX_ID = ISNULL(MAX(F_ID),0) FROM T_AUTH_RES_DIM_RELATIONS;
SET @DIM_MAX_ID = @DIM_MAX_ID+1;
INSERT INTO T_AUTH_RES_DIM_RELATIONS(F_ID,F_PRIMARY_PROPERTY,F_DATA_RESOURCE_ID,F_DIMENSION_FULL_CODE,F_NAME,F_DISPLAY_NAME) VALUES(@DIM_MAX_ID,'Dept',@RESOURCE_MAX_ID,'GTP.Org.Dept','GTP.Org.Dim.OwnerDepartment','归属部门');
SET @DIM_INSERT_NUM = @DIM_INSERT_NUM+1;
  ELSE
SELECT @DIM_MAX_ID=F_ID FROM T_AUTH_RES_DIM_RELATIONS WHERE F_PRIMARY_PROPERTY='Dept' AND F_DATA_RESOURCE_ID = @RESOURCE_MAX_ID AND F_NAME='GTP.Org.Dim.OwnerDepartment';
UPDATE T_AUTH_RES_DIM_RELATIONS SET F_DIMENSION_FULL_CODE='GTP.Org.Dept',F_DISPLAY_NAME='归属部门' WHERE F_ID=@DIM_MAX_ID;
END;

   SELECT @Row_Count = COUNT(*) FROM T_AUTH_RES_DIM_RELATIONS WHERE F_PRIMARY_PROPERTY='Creator' AND F_DATA_RESOURCE_ID = @RESOURCE_MAX_ID AND F_NAME='GTP.Org.Dim.OwnerUser';
IF (@Row_Count<1) THEN
SELECT @DIM_MAX_ID = ISNULL(MAX(F_ID),0) FROM T_AUTH_RES_DIM_RELATIONS;
SET @DIM_MAX_ID = @DIM_MAX_ID+1;
INSERT INTO T_AUTH_RES_DIM_RELATIONS(F_ID,F_PRIMARY_PROPERTY,F_DATA_RESOURCE_ID,F_DIMENSION_FULL_CODE,F_NAME,F_DISPLAY_NAME) VALUES(@DIM_MAX_ID,'Creator',@RESOURCE_MAX_ID,'GTP.Org.User','GTP.Org.Dim.OwnerUser','所有者');
SET @DIM_INSERT_NUM = @DIM_INSERT_NUM+1;
  ELSE
SELECT @DIM_MAX_ID=F_ID FROM T_AUTH_RES_DIM_RELATIONS WHERE F_PRIMARY_PROPERTY='Creator' AND F_DATA_RESOURCE_ID = @RESOURCE_MAX_ID AND F_NAME='GTP.Org.Dim.OwnerUser';
UPDATE T_AUTH_RES_DIM_RELATIONS SET F_DIMENSION_FULL_CODE='GTP.Org.User',F_DISPLAY_NAME='所有者' WHERE F_ID=@DIM_MAX_ID;
END;
--------------------生成权限项脚本------------------------------
--/****** Object:  Table [dbo].[T_AUTH_FUNCTIONS]Script Date: 2021/8/27 13:56:11 ******/--

SELECT @Row_Count = COUNT(*) FROM T_AUTH_FUNCTIONS WHERE F_FULL_CODE = @AuthFullCode;
IF (@Row_Count>0) THEN
SELECT @FUNCTION_MAX_ID = F_FUNCTION_ID FROM T_AUTH_FUNCTIONS WHERE F_FULL_CODE = @AuthFullCode;
   SET @ModuleTreeFullCode='';
 SELECT  @ModuleTreeFullCode=F_FULL_CODE FROM T_Module_Tree Where F_Code=@ModuleCode;
UPDATE T_AUTH_FUNCTIONS SET F_TREE_FULL_CODE=@ModuleTreeFullCode, F_DISPLAY_NAME = @ActionDisplayName, F_FULL_CODE = @AuthFullCode, F_LABEL =1, F_RESOURCE_ID =@RESOURCE_MAX_ID,F_MODULE_CODE =@ModuleCode,F_DEFAULT_CONTAIN_TYPE=NULL WHERE F_FUNCTION_ID = @FUNCTION_MAX_ID;
IF(@HASUPDATE>0) THEN
SET @UPDATE_INDEXS=CONCAT(TO_CHAR(@FUNCTION_MAX_ID),',',@UPDATE_INDEXS);
ELSE
SET @HASUPDATE=1;
SET @UPDATE_INDEXS=CONCAT(TO_CHAR(@FUNCTION_MAX_ID),',');
END;
ELSE
SELECT @FUNCTION_MAX_ID=ISNULL(MAX(F_FUNCTION_ID), 0) FROM T_AUTH_FUNCTIONS;
SET @FUNCTION_MAX_ID =@FUNCTION_MAX_ID+1;
SET @ModuleTreeFullCode='';
 SELECT  @ModuleTreeFullCode=F_FULL_CODE FROM T_Module_Tree Where F_Code=@ModuleCode;

INSERT INTO T_AUTH_FUNCTIONS(F_FUNCTION_ID, F_DISPLAY_NAME, F_FULL_CODE, F_IS_BUILDIN, F_LABEL, F_RESOURCE_ID, F_MODULE_CODE,F_FNGROUP_ID,F_INSTANCE_SELECTABLE,F_COLUMNS_SELECTABLE,F_CONDITION_SELECTABLE,F_DEFAULT_CONTAIN_TYPE,F_TREE_FULL_CODE) 
VALUES (@FUNCTION_MAX_ID,@ActionDisplayName, @AuthFullCode, 1, '1', @RESOURCE_MAX_ID, @ModuleCode,null,1,0,1,NULL,@ModuleTreeFullCode);
SET @FUNCTION_INSERT_NUM = @FUNCTION_INSERT_NUM + 1; 
IF(@HASUPDATE>0) THEN
SET @UPDATE_INDEXS=CONCAT(TO_CHAR(@FUNCTION_MAX_ID),',',@UPDATE_INDEXS);
ELSE
SET @HASUPDATE=1;
SET @UPDATE_INDEXS=CONCAT(TO_CHAR(@FUNCTION_MAX_ID),',');
END;
END;
/****** Object:  Table [dbo].[GTP_SEQUENCE]Script Date: {0} ******/ 

--更新SEQUENCE
--SELECT @GROUP_CURRENT_VALUE = ISNULL(VALUE, 0) FROM GTP_SEQUENCE WHERE NAME = 'GTP.Auth.Biz.Fn.FnGroup.Id';
--UPDATE GTP_SEQUENCE SET VALUE = @GROUP_CURRENT_VALUE + @GROUP_INSERT_NUM WHERE NAME = 'GTP.Auth.Biz.Fn.FnGroup.Id';
SELECT @RESOURCE_CURRENT_VALUE = ISNULL(VALUE, 0) FROM GTP_SEQUENCE WHERE NAME = 'GTP.Auth.Biz.T_AUTH_RESOURCE' for update;
UPDATE GTP_SEQUENCE SET VALUE = @RESOURCE_CURRENT_VALUE + @RESOURCE_INSERT_NUM WHERE NAME = 'GTP.Auth.Biz.T_AUTH_RESOURCE';
SELECT @FUNCTION_CURRENT_VALUE = ISNULL(VALUE, 0) FROM GTP_SEQUENCE WHERE NAME = 'GTP.Auth.Biz.T_AUTH_FUNCTIONS' for update;
UPDATE GTP_SEQUENCE SET VALUE = @FUNCTION_CURRENT_VALUE + @FUNCTION_INSERT_NUM WHERE NAME = 'GTP.Auth.Biz.T_AUTH_FUNCTIONS';
SELECT @RES_MOD_REL_CURRENT_VAL = ISNULL(VALUE, 0) FROM GTP_SEQUENCE WHERE NAME = 'GTP.Auth.Biz.T_AUTH_RES_MODULE_REL' for update;
UPDATE GTP_SEQUENCE SET VALUE = @RES_MOD_REL_CURRENT_VAL + @RES_MOD_REL_INSERT_NUM WHERE NAME = 'GTP.Auth.Biz.T_AUTH_RES_MODULE_REL';
SELECT @DIM_CURRENT_VALUE = ISNULL(VALUE, 0) FROM GTP_SEQUENCE WHERE NAME = 'GTP.Auth.Biz.T_AUTH_RES_DIM_RELATIONS' for update;
UPDATE GTP_SEQUENCE SET VALUE = @DIM_CURRENT_VALUE + @DIM_INSERT_NUM WHERE NAME = 'GTP.Auth.Biz.T_AUTH_RES_DIM_RELATIONS';

GO
```